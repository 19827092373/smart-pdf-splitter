name: Deploy to Aliyun

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy via SCP
        run: scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 -r ./* root@${{ secrets.SERVER_IP }}:/www/wwwroot/pdf.teacherlab.cn/

      - name: Stop existing streamlit
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@${{ secrets.SERVER_IP }} 'pkill -9 -f "[s]treamlit.*app.py" 2>/dev/null || true'

      - name: Clean and restart service
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@${{ secrets.SERVER_IP }} 'cd /www/wwwroot/pdf.teacherlab.cn && rm -rf .github .git .gitignore .claude *.md deploy.sh sync.sh update.sh start.sh 2>/dev/null; sleep 2; if [ -d venv ]; then source venv/bin/activate; fi; nohup python3 -m streamlit run app.py --server.port=8501 --server.address=0.0.0.0 > streamlit.log 2>&1 & sleep 3; echo done'

      - name: Health check
        run: |
          sleep 10
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} 'curl -sf http://localhost:8501/_stcore/health && echo OK || (echo "Health check failed, showing logs:" && tail -50 /www/wwwroot/pdf.teacherlab.cn/streamlit.log; exit 1)'
