name: Deploy to Aliyun

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Deploy via SCP
        run: |
          scp -r . root@${{ secrets.SERVER_IP }}:/www/wwwroot/pdf.teacherlab.cn
      
      - name: Clean up unnecessary files on server
        run: |
          ssh root@${{ secrets.SERVER_IP }} "cd /www/wwwroot/pdf.teacherlab.cn && rm -rf .github .git .gitignore .claude *.md deploy.sh sync.sh update.sh"

      - name: Create and run startup script
        run: |
          ssh root@${{ secrets.SERVER_IP }} "cat > /www/wwwroot/pdf.teacherlab.cn/start.sh << 'SCRIPT'
          #!/bin/bash
          cd /www/wwwroot/pdf.teacherlab.cn
          pkill -9 -f \"streamlit run app.py\" 2>/dev/null || true
          sleep 2
          if [ -d \"venv\" ]; then
            source /www/wwwroot/pdf.teacherlab.cn/venv/bin/activate
          fi
          nohup python3 -m streamlit run app.py --server.port=8501 --server.address=0.0.0.0 >> streamlit.log 2>&1 &
          SCRIPT
          chmod +x /www/wwwroot/pdf.teacherlab.cn/start.sh
          /www/wwwroot/pdf.teacherlab.cn/start.sh
          echo Started"

      - name: Wait and health check
        run: |
          ssh root@${{ secrets.SERVER_IP }} "sleep 8 && curl -sf http://localhost:8501/_stcore/health || (tail -50 /www/wwwroot/pdf.teacherlab.cn/streamlit.log && exit 1)"
