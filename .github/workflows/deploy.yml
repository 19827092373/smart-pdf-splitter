name: Deploy to Aliyun

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Add known hosts with retry
          for i in 1 2 3; do
            ssh-keyscan -T 30 -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts && break
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          # Verify SSH key format
          echo "SSH key loaded, testing connection..."

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=15 -o ServerAliveCountMax=3 root@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"

      - name: Deploy via SCP
        run: scp -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=15 -r ./* root@${{ secrets.SERVER_IP }}:/www/wwwroot/pdf.teacherlab.cn/

      - name: Stop and restart service
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=15 root@${{ secrets.SERVER_IP }} << 'ENDSSH'
          set -e
          echo "=== Stopping existing streamlit ==="
          pkill -9 -f 'streamlit.*app.py' 2>/dev/null || true
          sleep 2
          echo "Stopped existing streamlit processes"
          
          echo "=== Cleaning up unnecessary files ==="
          cd /www/wwwroot/pdf.teacherlab.cn || exit 1
          rm -rf .github .git .gitignore .claude *.md deploy.sh sync.sh update.sh start.sh 2>/dev/null || true
          rm -rf .streamlit 2>/dev/null || true
          
          echo "=== Starting streamlit ==="
          if [ -d venv ]; then
            source venv/bin/activate
            echo "Using virtual environment"
          fi
          nohup python3 -m streamlit run app.py --server.port=8501 --server.address=0.0.0.0 > streamlit.log 2>&1 &
          echo "Streamlit started with PID: $!"
          ENDSSH

      - name: Health check
        run: |
          echo "Waiting 30 seconds for Streamlit to fully start..."
          sleep 30
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=15 root@${{ secrets.SERVER_IP }} << 'ENDSSH'
          echo "Checking Streamlit health..."
          if curl -sf --max-time 10 http://localhost:8501/_stcore/health; then
            echo "Health check passed!"
          else
            echo "Health check failed, showing logs:"
            tail -100 /www/wwwroot/pdf.teacherlab.cn/streamlit.log
            exit 1
          fi
          ENDSSH
